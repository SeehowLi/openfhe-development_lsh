# 功能开发日志

## 日志模板

2025-07-07是第一次写开发日志，用于记录

### 日期：2025-07-07

**功能名称**：[离散CKKS的实现]
 **开发时长**：[X小时]

#### 完成内容

- [x] 增加调试功能记录文件

> 可执行文件在/lsh目录下面的git_push.sh
>
> 已经将快速命令写入到了bashrc中，直接调用
>
> `gpush 这是一个测试，具体内容可以修改`
>
> 即可

- [x] 增加AI总结代码生成文件

> 运行脚本smatrt_collect.sh即可，生成的内容在code_chunks目录下

- [x] 增加DISCRETECKKS的Enable开启标志位
- [x] 完成CtS和StC的的CryptoContext的全局调用(cc->EvalCtS/EvalStC)
- [x] 实现的StC和CtS的具体功能

#### 学到的经验

1. 基本的上传GitHub已经弄好了
2. StC和CtS如果要是单开一个DISCRETECKKS的标志位的话，precompute要重新定义，因为不是一个目录下面的了好像，这个具体还没搞明白，因为我以为只要是一个指针类下面的就可以了
3. StC和CtS的功能还没有实现，会报错：段错误。目前还没有搞清楚原因，准备先暂时放一下，相关问题已经去OpenFHE论坛上询问。

#### 下一步计划

- StC和CtS完善好
- 进行模约简和MSB自举的实现

#### 今日总结

效率还可以，总体实现了一些功能。日后要每天都敲一下代码，看一看具体的实现不然会生疏，而且随着时间的积累，对整个库的了解对越来越深入。

### 日期：2025-07-09/10

**功能名称**：[StC和CtS的修改以及sorting函数的融合]
 **开发时长**：[X小时]

#### 完成内容

- [x] 实现StC和CtS的具体功能–不报错

> 去OpenFHE论坛发的贴子Yuri进行了回应，内容为：
>
> > `EvalMultExt` works with extended ciphertexts, i.e., the ciphertext is extended from modulus Q to QP. The RNS limbs in `fastRotation[0]` and `A[s][G]` (precomputed) should match for `EvalMultExt` to work correctly. In your case, the number of RNS limbs is probably mismatched as you use `EvalStC` after bootstrapping. At a high level, the precomputation of the linear maps, which is done as part of `EvalBootstrapPrecompute`, should be also called for your case (at the right CKKS RNS levels). Basically you will need a custom version of `EvalLinearTransformPrecompute` for this to work.

- [ ] StC和CtS的输出结果可以进行解密，即实现完善的StC和CtS功能

> 目前可以进行StC了完整计算了，但是输出结果解密会出错误：
>
> > `Decode(): The decryption failed because the approximation error is too high. Check the parameters.`
>
> 记得BTS整个流程中在CtS最后会进行额外的步骤，应该是CtS的后端处理，这里去完善实现一下，希望封装StC和CtS成为一个独立的操作模块。

- [x] 学一下序列化的过程–serialize

> 序列化和我常规理解的保存计算的结果到文件然后下次不用算直接来读取文件调用不一样，序列化可以简单理解为打包程序，保存整个程序的状态，在OpenFHE中，需要保存context，密钥，密文等等，让其可以在另一个电脑、另一个时间甚至另一个人来使用，可以让数据拥有者和计算着分离。

#### 学到的经验

1. 
2. 

#### 下一步计划

- 

#### 存在的问题

- `EvalBootstrapSetup`中的correctionFactor校正因子参数还没有弄清楚他的作用是什么？

- 序列化这些代码都是什么意思？

  - > ```c++
    > template <class Archive>
    > 
    >   void load(Archive& ar) {
    > 
    > ​    ar(cereal::base_class<FHERNS>(this));
    > 
    > ​    ar(cereal::make_nvp("paramMap", m_bootPrecomMap));
    > 
    > ​    // 新增
    > 
    > ​    ar(cereal::make_nvp("linearTransformMap", m_linearTransformPrecomMap));  
    > 
    > ​    ar(cereal::make_nvp("corFactor", m_correctionFactor));
    > 
    >   }
    > ```


- 

#### 今日总结–心路历程

改了层级还是出问题，现在准备去EvalLinearTransformPrecompute函数里面看看到底怎么个事。

现在CtS和StC已经可以正常运行了，但是奇怪的是运行StC或者是CtS之后，结果并没有变，看起来好像是一个恒等变换，这不应该。相关问题已经去OpenFHE论坛上面提问，希望可以解决。

有没有可能是旋转索引等东西没搞的原因？因为如果把`EvalBootstrapSetup`注释掉会报错：

>  what():  D:/openfhe-development/src/pke/lib/scheme/ckksrns/ckksrns-fhe.cpp:l.1034:FindBootstrapRotationIndices(): Precomputations for 8 slots were not generated Need to call EvalBootstrapSetup to proceed

### 日期：2025-07-11

**功能名称**：[集成*Lightweight Sorting in Approximate Homomorphic Encryption*代码进OpenFHE]
 **开发时长**：[X小时]

#### 完成内容

- [x] 开发HomoEncryptCompute(HEC)作为openfhe.h的上层api
- [x] 集成utils到sortingutils之中
- [x] 集成Permutation和Network两种实现到SortingMethod之中

### 日期：2025-07-xx

**功能名称**：[]
 **开发时长**：[X小时]

#### 完成内容

- [ ] 

> 

#### 学到的经验

1. 
2. 

#### 下一步计划

- 先把平方之后的数据输出出来看一下应该输出多少
- 对比旋转的加密结果然后判断是否旋转出错，如果出错，写一个专门的例子看一下旋转的索引和稀疏打包之间的关系
- 完成求和之后使用切比雪夫近似完成sqrt的计算

### 日期：2025-07-11

**功能名称**：[集成*Lightweight Sorting in Approximate Homomorphic Encryption*代码进OpenFHE]
 **开发时长**：[X小时]

#### 完成内容

- [x] 开发HomoEncryptCompute(HEC)作为openfhe.h的上层api
- [x] 集成utils到sortingutils之中
- [x] 集成Permutation和Network两种实现到SortingMethod之中

### 日期：2025-07-15

**功能名称**：[KNN的sorting函数适配]
 **开发时长**：[4小时]

#### 完成内容

- [x] 计算未开根的求和结果大小
- [ ] 验证旋转的关系

> 不需要gap,直接当作密集打包的来旋转就行,旋转内部的函数会自动对齐

#### 学到的经验

1. 
2. 

#### 下一步计划

- 先把平方之后的数据输出出来看一下应该输出多少
- 对比旋转的加密结果然后判断是否旋转出错，如果出错，写一个专门的例子看一下旋转的索引和稀疏打包之间的关系
- 完成求和之后使用切比雪夫近似完成sqrt的计算



## 踩过的坑

- 输出一定不要有中文字符，会报错。
- 

## TODO

- [ ] 修改HemoEncryptCompute中间的函数和v1.2.4版本适配
- [ ] 怎么完成稀疏打包不同batchsize的切换
  更详细来说怎么完成稀疏打包下面的不同有效槽位之间的转换，在不解密的情况下

> - [x] 写一个求助帖子
> - [x] 需要旋转密文把有效数据都放到前面来，setslots好像只会从前到后保持
>   需要去底层的函数去验证。直接去底层看吧，明确好了再做决定。
> - [x] 打包函数MakeCKKSPackedPlaintext
> - [x] slots的确定
>
> 看了，打包用的IDFT，不是简单的线性罗列，因为仍需要rotate
>
> 不行，不能乱改slot数量，完蛋了–如何实现slot的改变也是一个创新点









### 日期：2025-07-xx

**功能名称**：[]
 **开发时长**：[X小时]

#### 完成内容

- [ ] 

> 

#### 学到的经验

1. 
2. 

#### 下一步计划

- 

#### 今日总结







